# Pi Camera Capture Specification

このドキュメントでは、MkECTLの仕様をまとめます。

## 新機能
- Lark を用いた構文解析による DSL インタープリタを追加しました。
- GUIフレームワークを PySide6 に移行しました。
- PySide6 API に合わせて `Signal` などの記法を更新しました。
- 変数、数式、ループ、ユーザー定義関数を利用できます。
- 画像統計ダイアログを追加し、ヒストグラム表示とピクセル情報を確認できるようにしました。
- 画像ビューアにスムージングのON/OFFを切り替えるチェックボックスを追加しました。

## PySide6 移行時の注意事項
* `QFont.setWeight()` には整数ではなく `QFont.Weight` 列挙型を渡します。
* `exec_()` メソッドは `exec()` に名前が変わっています。
* Linux 環境では `libxcb-cursor0` が必要です。未インストールの場合は
  `xcb-cursor0 or libxcb-cursor0 is needed to load the Qt xcb platform plugin`
  というエラーが発生します。
* PySide6 で `qtutils` を利用するにはバージョン `4.0.0` 以上が必要です。

## サンプル
```dsl
set x, 3
function demo(n){
    for i in range(0, n){
        mov 0, i*10, 0
    }
}
demo(x)
```


以下は、既存のドメイン固有言語（DSL）スクリプトをLarkを用いた構文解析に置き換え、式・変数・サブルーチンなどを扱えるようにするための計画案です。

1. 現状把握
現在のDSLで使用しているコマンドや記法を整理する

既存実装（文字列比較によるインタープリタ）の処理フロー、制御構造、機能制限などを確認

2. 対応する機能の決定
基本コマンド（移動、カメラ操作など）

変数・式の評価

制御構文（条件分岐、ループ）

サブルーチン（手続き定義と呼び出し）

エラーハンドリングやデバッグ支援の仕組み

3. 文法設計
DSLのトークン（キーワード、記号、識別子、数値など）をリストアップ

上記機能を満たすための文法を設計

例：

move x y z や move(x, y, z)

var x = 10

if condition { ... } else { ... }

function name(params) { ... }

Lark向けのBNFスタイルで文法定義を作成し、ファイルにまとめる（例：dsl_grammar.lark）

4. パーサの実装
Larkを用いてBNF文法を読み込み、パーサ生成

from lark import Lark
parser = Lark.open("dsl_grammar.lark", parser="lalr")
解析結果（抽象構文木：AST）に対して評価・実行を行うクラスや関数を実装

変数や関数テーブルを持つコンテキスト管理

ASTの各ノードに対応する実行メソッドの追加

5. 機能実装の方針
変数・式

四則演算、比較演算、代入などを行う

式の評価はAST上で再帰的に実装

制御構造

if / else, while / for などをAST上で処理

サブルーチン

function で定義し、名前で呼び出せるようにする

引数／戻り値の仕様を決めておく

組み込みコマンド

既存のロボット制御コマンドとの連携方法を確認し、サブルーチンやステートマシン構造で呼び出せるよう拡張

6. 移行計画
まず最小構成（既存の単純コマンドと変数代入）を新実装で動作させる

既存の文字列比較型インタープリタと併用しながら段階的に切り替える

環境変数 `MK_USE_LARK=1` を設定すると、新しいLarkベースのインタプリタでスクリプトを実行できます。既定では従来のインタプリタを使用します。

テスト用スクリプトを複数パターン準備し、新旧実装で結果が一致するか確認

機能追加（ループ、サブルーチンなど）を段階的に導入

7. ドキュメント整備
DSLの構文仕様書を作成・更新

既存ドキュメント (README.md や spec_picamcapture.md 等) に使用方法と新機能を追記

ユーザー向けサンプルスクリプトやチュートリアルを用意

8. 保守・拡張
言語仕様変更が容易になるよう、文法ファイルと実行クラスを分離し管理

将来的な機能（マクロ、例外処理など）の追加を想定した設計

